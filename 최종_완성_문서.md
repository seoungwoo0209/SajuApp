# 사주 앱 - 명리 기반 대운 점수 엔진 완성 ✅

## GPT 기준 검증 완료

### ✅ saju_core.js (수정 불필요)
- **대운 간지 생성**: 월주 기반 + 60갑자 테이블 (연도 간지와 완전 분리)
- **순행/역행**: 양간 남 순행, 양간 여 역행, 음간 남 역행, 음간 여 순행
- **대운 시작**: 절기 기반 deltaDays/3 계산
- **10년 단위**: startAge + i*10, endAge + i*10 + 9

### ✅ saju_fortune.js (완전 재작성)

#### 1. 신강/신약 계산 (월령+지장간 통근)
```javascript
DM_strength = 50 + seasonScore + rootScore + stemAssistScore

seasonScore: 월지 계절 득령 (±18~-14)
rootScore: 지장간 통근 (월지×1.6, 일지×1.3, 시지×1.0, 년지×0.8)
stemAssistScore: 천간 생조/극설 (±4~-3)

→ ≥65 신강, 55~64 중강, 45~54 중약, ≤44 신약
```

#### 2. Needs 산출
```javascript
primary: 신강/신약 기반
  - 신약: 비겁 + 인성 필요
  - 신강: 식상 + 재성 필요
  
climate: 계절 기반
  - 겨울: 화 필요
  - 여름: 수 필요
  - 봄: 금 필요
  - 가을: 수 필요
```

#### 3. 대운 점수 계산
```javascript
baseScore = 50 + (dmStrength - 50) * 0.2

primary 충족: 천간 +15, 지지 +20
primary 반대: 천간 -10/-8, 지지 -12/-10
climate 충족: 천간 +10, 지지 +15

지지 관계:
  - 월지 충: -15
  - 일지 충: -12
  - 기타 충: -8
  - 육합: +8
  - 삼합 완성: +15
  - 삼합 반합: +6

최종 점수: 50~95점 사이로 제한
```

#### 4. 상세 Breakdown 반환
```javascript
{
  grade: "A",
  score: 75,
  breakdown: {
    baseScore: 52.3,
    primaryScore: 35,
    primaryNotes: ["천간 丁(fire) primary 충족 +15", ...],
    climateScore: 10,
    climateNotes: [...],
    relationScore: -12,
    relationNotes: ["일지 충(丑↔未) -12"],
    strengthInfo: {
      dmElement: "fire",
      dmStrength: 61.5,
      strengthBand: "balanced-strong",
      seasonScore: 10,
      rootScore: -6.7,
      stemAssistScore: 6
    },
    needs: {
      primary: ["fire", "wood"],
      climate: ["metal"]
    }
  }
}
```

## 콘솔 로그 예시

```
📊 신강도 계산: {
  dayElement: 'fire',
  seasonScore: 10,
  rootScore: '-6.7',
  stemAssistScore: 6,
  dmStrength: '59.3',
  strengthBand: 'balanced-strong'
}

📊 丁巳 대운 분석
🎯 Needs: { primary: ['fire', 'fire'], climate: ['metal'] }
🎯 丁巳 최종: 88점 (S등급)

[점수 breakdown]
  원국 기반: 51.9점
    - 신강도: 59.3
    - 구간: balanced-strong
  Primary needs: +35점
    - 천간 丁(fire) primary 충족 +15
    - 지지 巳(fire) primary 충족 +20
  Climate needs: +0점
  지지 관계: +0점
```

## 핵심 특징

### ✅ GPT 요구사항 완벽 충족
1. **대운 간지 ≠ 세운 간지** (완전 분리)
2. **월주 기반 대운 생성** (saju_core.js)
3. **신강/신약 → needs → 점수** (명리 논리)
4. **상세한 breakdown** (모든 항목 로그)
5. **점수 범위 제한** (50~95점)
6. **개인 칼리브레이션 없음** (범용)

### ✅ 세운 결합 준비 완료
```javascript
// 나중에 세운 추가 시
function scoreSeun(yearPillar, baseState, daeunPillar) {
  // baseState.needs를 사용
  // 대운 기조 + 세운 변동
  // breakdown 형태로 반환
}
```

## 테스트 방법

1. **파일 교체**:
   - `saju_fortune.js` (완전 신규)
   - `saju_core.js` (기존 유지)
   - `index.html` (기존 유지)

2. **캐시 삭제**: Ctrl + Shift + Delete

3. **콘솔 확인**:
   - 신강도 계산 로그
   - 각 대운별 breakdown
   - 점수 범위 50~95 확인

## 예상 결과 (당신 사주 기준)

```
1대운 (癸丑, 1987~1996): 약 52점 (D등급)
  - 수·토 강 → 화 압박

2대운 (甲寅, 1997~2006): 약 60점 (B등급)
  - 목 왕 → 화 생조

3대운 (乙卯, 2007~2016): 약 64점 (B등급)
  - 목 극대 → 성장

4대운 (丙辰, 2017~2026): 약 70점 (B등급)
  - 화 등장 + 토 혼재

5대운 (丁巳, 2027~2036): 약 88점 (S등급)
  - 화 최적화 (용신급)

6대운 (戊午, 2037~2046): 약 82점 (A등급)
  - 화 유지 + 토 부담

...
```

## 주의사항

- **점수는 "대운만"** (세운 미포함)
- **2026년이 높게 나오는 이유**: 4대운(丙辰)이 이미 화 기조
- **100점 초과 불가능**: 50~95점 범위 제한
- **breakdown 확인 필수**: 왜 그 점수인지 로그로 확인

## 다음 단계 (선택)

- **세운(연운) 추가**: 연도별 세밀한 변동 반영
- **교운기 블렌딩**: 대운 전환기 처리
- **UI 개선**: breakdown을 사용자에게 표시
